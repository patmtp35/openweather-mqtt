âœ… SynthÃ¨se des correctifs nÃ©cessaires pour openweather-mqtt
1ï¸âƒ£ Contexte de dÃ©part

OS : Raspberry Pi OS / Debian

Python : 3.13.x

Broker MQTT : Mosquitto

allow_anonymous false

authentification obligatoire (username/password)

Projet : https://github.com/rsaikali/openweather-mqtt

(ancien, non maintenu)

2ï¸âƒ£ ProblÃ¨mes rencontrÃ©s
âŒ ProblÃ¨me 1 â€” IncompatibilitÃ© des dÃ©pendances Python

Erreur :

ModuleNotFoundError: No module named 'urllib3.packages.six.moves'


Cause

urllib3 >= 2.x a supprimÃ© six

le projet dÃ©pend implicitement de six

Python 3.13 installe par dÃ©faut urllib3 2.x

âŒ ProblÃ¨me 2 â€” OpenWeather API refusÃ©e (401)

Erreurs :

HTTP 401 Unauthorized
KeyError: 'dt'


Causes

Variable dâ€™environnement OPENWEATHER_APP_ID absente

Valeur par dÃ©faut YOUR_OPENWEATHER_APP_ID utilisÃ©e

Script ne gÃ¨re pas les erreurs API

URL OpenWeather en HTTP au lieu de HTTPS

âŒ ProblÃ¨me 3 â€” Refus MQTT (Not authorized)

Erreur :

paho.mqtt.MQTTException: Not authorized


Cause

Le script publiait sur MQTT sans authentification

Or Mosquitto avait allow_anonymous false

3ï¸âƒ£ Correctifs Python (OBLIGATOIRES)
ğŸ”§ CrÃ©ation dâ€™un environnement virtuel
python3 -m venv venv
source venv/bin/activate

ğŸ”§ Versions compatibles des librairies
pip install --upgrade pip
pip install requests==2.31.0 "urllib3<2" six paho-mqtt


ğŸ“Œ Important

urllib3<2 est indispensable

six doit Ãªtre installÃ© explicitement

fonctionne avec Python 3.9 â†’ 3.13

4ï¸âƒ£ Variables dâ€™environnement requises

Le projet ne fonctionne PAS sans variables dâ€™environnement.

export OPENWEATHER_APP_ID=<CLE_API_OPENWEATHER>
export OPENWEATHER_CITY_ID=xxxxxxxxx

export MQTT_SERVICE_HOST=xxxxxxxxx
export MQTT_SERVICE_PORT=1883
export MQTT_SERVICE_TOPIC=home/livingroom

export MQTT_USERNAME=admin
export MQTT_PASSWORD='motdepasse'

export MQTT_CLIENT_ID=openweather-mqtt-service


âš ï¸ Si OPENWEATHER_APP_ID nâ€™est pas dÃ©fini â†’ 401 garanti

5ï¸âƒ£ Modifications obligatoires du script Python
âœ… 5.1 Passage de HTTP â†’ HTTPS (OpenWeather)

ğŸ”´ Avant

http://api.openweathermap.org


ğŸŸ¢ AprÃ¨s

https://api.openweathermap.org

âœ… 5.2 Ajout de lâ€™authentification MQTT (CRITIQUE)
ğŸ”§ Ajout des variables
MQTT_USERNAME = os.getenv('MQTT_USERNAME')
MQTT_PASSWORD = os.getenv('MQTT_PASSWORD')

ğŸ”§ Modification de publish.multiple

ğŸ”´ Avant

publish.multiple(
    msgs,
    hostname=MQTT_SERVICE_HOST,
    port=MQTT_SERVICE_PORT
)


ğŸŸ¢ AprÃ¨s

publish.multiple(
    msgs,
    hostname=MQTT_SERVICE_HOST,
    port=MQTT_SERVICE_PORT,
    client_id=MQTT_CLIENT_ID,
    auth={
        'username': MQTT_USERNAME,
        'password': MQTT_PASSWORD
    }
)


ğŸ“Œ Sans cela â†’ MQTTException: Not authorized

âœ… 5.3 (Optionnel mais recommandÃ©) Robustesse API

Le script suppose que data['dt'] existe, ce qui est faux en cas dâ€™erreur API.

ğŸ‘‰ Une protection minimale recommandÃ©e :

if 'dt' not in data:
    logger.error(f"Invalid OpenWeather response: {data}")
    time.sleep(60)
    continue

6ï¸âƒ£ RÃ©sultat final

âœ”ï¸ Compatible Python 3.13

âœ”ï¸ Compatible Mosquitto sÃ©curisÃ©

âœ”ï¸ OpenWeather API fonctionnelle

âœ”ï¸ Publication MQTT visible dans MQTT Explorer

âœ”ï¸ Topics :

home/livingroom/main/temp
home/livingroom/main/humidity
home/livingroom/weather/0/description

7ï¸âƒ£ Conclusion pour le dÃ©veloppeur

Le projet openweather-mqtt fonctionne toujours en 2025,
mais nÃ©cessite impÃ©rativement :

le gel des dÃ©pendances Python (urllib3 < 2)

lâ€™utilisation de HTTPS pour OpenWeather

la gestion explicite de lâ€™authentification MQTT

des variables dâ€™environnement correctement injectÃ©es

Sans ces correctifs, le script Ã©choue silencieusement ou retourne des erreurs 401 / MQTT Not authorized.
